name: ðŸ” Dependency Update & Security

on:
  schedule:
    - cron: '0 0 * * 1' # Every Monday at midnight
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: ðŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ðŸ“¦ Install npm-check-updates
        run: npm install -g npm-check-updates
      
      - name: ðŸ”„ Update dependencies
        working-directory: ./frontend
        run: |
          ncu -u
          npm install
      
      - name: ðŸ§ª Test updated dependencies
        working-directory: ./frontend
        run: npm run build
        continue-on-error: true
      
      - name: ðŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'â¬†ï¸ chore: update dependencies'
          title: 'â¬†ï¸ Weekly Dependency Updates'
          body: |
            ## ðŸ“¦ Dependency Updates
            
            This PR updates all dependencies to their latest versions.
            
            ### âš ï¸ Important
            - Review the changes carefully
            - Check for breaking changes
            - Test thoroughly before merging
            
            ### ðŸ” What to check:
            - Build passes âœ…
            - No breaking changes
            - Security vulnerabilities fixed
            
            ---
            *Auto-generated weekly dependency update*
          branch: deps/weekly-update
          delete-branch: true
          labels: |
            dependencies
            automated

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: ðŸ”’ Run npm audit
        working-directory: ./frontend
        run: |
          npm audit --json > audit-results.json || true
          cat audit-results.json
      
      - name: ðŸ“Š Generate security report
        run: |
          echo "# ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security scan completed. Check audit-results.json for details." >> $GITHUB_STEP_SUMMARY
