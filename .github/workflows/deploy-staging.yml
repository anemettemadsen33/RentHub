name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  KUBE_NAMESPACE: renthub-staging

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.renthub.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
        kubectl config use-context staging
    
    - name: Update image tags
      run: |
        cd k8s/overlays/staging
        kustomize edit set image \
          renthub/backend=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }} \
          renthub/frontend=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
    
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -k k8s/overlays/staging/
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/backend -n ${{ env.KUBE_NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/frontend -n ${{ env.KUBE_NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/queue-worker -n ${{ env.KUBE_NAMESPACE }} --timeout=5m
    
    - name: Run database migrations
      run: |
        kubectl exec -n ${{ env.KUBE_NAMESPACE }} deployment/backend -- php artisan migrate --force
    
    - name: Verify deployment
      run: |
        kubectl get pods -n ${{ env.KUBE_NAMESPACE }}
        kubectl get svc -n ${{ env.KUBE_NAMESPACE }}
        kubectl get ingress -n ${{ env.KUBE_NAMESPACE }}
    
    - name: Run smoke tests
      run: |
        sleep 30
        curl -f https://staging.renthub.com/health || exit 1
        curl -f https://api.staging.renthub.com/health || exit 1
    
    - name: Notify deployment success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'Staging deployment successful! :rocket:'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Notify deployment failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'Staging deployment failed! :x:'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
