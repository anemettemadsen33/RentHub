name: Complete E2E Testing

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  PHP_VERSION: '8.2'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== E2E TESTS ====================
  e2e-tests:
    name: ğŸ§ª End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, intl, xml, ctype, json, tokenizer, bcmath, redis
          coverage: none
          tools: composer:v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Get Composer Cache Directory
        id: composer-cache
        working-directory: ./backend
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: composer install --prefer-dist --no-progress --no-interaction --no-scripts
      
      - name: Prepare Laravel Application
        working-directory: ./backend
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan config:clear
          php artisan cache:clear
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
      
      - name: Run migrations and seed E2E data
        working-directory: ./backend
        run: |
          php artisan migrate:fresh --force
          php artisan db:seed --class=E2ESeeder --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
      
      - name: Start Laravel backend
        working-directory: ./backend
        run: |
          php artisan serve --host=127.0.0.1 --port=8000 &
          sleep 5
          curl -f http://localhost:8000/api/health || echo "Backend not ready yet"
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install chromium --with-deps
      
      - name: Run Playwright E2E tests
        working-directory: ./frontend
        run: npm run e2e
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000/api
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8000/api/v1
          NEXT_PUBLIC_E2E: 'true'
          CI: 'true'
      
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 30
      
      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: frontend/playwright-report/index.html
          retention-days: 30
      
      - name: Generate test summary
        if: always()
        run: |
          echo "## ğŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "frontend/playwright-report.json" ]; then
            echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat frontend/playwright-report.json | head -50 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test report not generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Authentication flows" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Property search and filters" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Booking flow" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Payment processing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… User profile management" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Reviews and ratings" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Messaging system" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Owner dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Advanced features (wishlists, saved searches, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Accessibility (WCAG 2.1 AA)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security audit" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Offline functionality" >> $GITHUB_STEP_SUMMARY

  # ==================== COMMENT ON PR ====================
  comment-results:
    name: ğŸ’¬ Comment Test Results
    needs: e2e-tests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ./playwright-report
      
      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportData = {};
            
            try {
              const reportPath = './playwright-report/playwright-report.json';
              if (fs.existsSync(reportPath)) {
                reportData = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              }
            } catch (e) {
              console.log('Could not read report:', e);
            }
            
            const comment = `## ğŸ§ª E2E Test Results
            
            ### Summary
            ${reportData.stats ? `
            - âœ… Passed: ${reportData.stats.passed || 0}
            - âŒ Failed: ${reportData.stats.failed || 0}
            - â­ï¸ Skipped: ${reportData.stats.skipped || 0}
            - â±ï¸ Duration: ${reportData.stats.duration || 'N/A'}
            ` : 'Test statistics not available'}
            
            ### Artifacts
            - ğŸ“Š [View full Playwright report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - ğŸ“ [Test results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Test Coverage
            - âœ… Authentication & Authorization
            - âœ… Property Management
            - âœ… Booking Flows
            - âœ… Payment Processing
            - âœ… User Profiles
            - âœ… Reviews & Ratings
            - âœ… Messaging
            - âœ… Dashboard Features
            - âœ… Accessibility (WCAG 2.1 AA)
            - âœ… Security Audit
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
