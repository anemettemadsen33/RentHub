name: Canary Deployment

on:
  workflow_dispatch:
    inputs:
      canary-percentage:
        description: 'Percentage of traffic for canary'
        required: true
        default: '10'
        type: choice
        options:
          - '10'
          - '25'
          - '50'
          - '75'
          - '100'

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: renthub-cluster

jobs:
  build-canary:
    name: Build Canary Release
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Generate Image Tag
        id: image-tag
        run: echo "tag=canary-$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
      
      - name: Build and Push Canary Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: renthub
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f backend/Dockerfile backend/
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:canary
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:canary

  deploy-canary:
    name: Deploy Canary Instance
    needs: build-canary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update Canary Task Definition
        run: |
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition renthub-canary \
            --query taskDefinition)
          
          NEW_TASK_DEF=$(echo $TASK_DEFINITION | jq --arg IMAGE "${{ secrets.ECR_REGISTRY }}/renthub:${{ needs.build-canary.outputs.image-tag }}" \
            '.containerDefinitions[0].image = $IMAGE')
          
          echo $NEW_TASK_DEF | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            > canary-task-def.json
      
      - name: Register Canary Task Definition
        run: |
          aws ecs register-task-definition \
            --cli-input-json file://canary-task-def.json
      
      - name: Deploy Canary Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service renthub-canary \
            --task-definition renthub-canary \
            --desired-count 1 \
            --force-new-deployment

  route-traffic:
    name: Route Traffic to Canary
    needs: deploy-canary
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update ALB Listener Rules
        run: |
          STABLE_TG_ARN=$(aws elbv2 describe-target-groups \
            --names renthub-stable \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text)
          
          CANARY_TG_ARN=$(aws elbv2 describe-target-groups \
            --names renthub-canary \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text)
          
          LISTENER_ARN=$(aws elbv2 describe-listeners \
            --load-balancer-arn ${{ secrets.ALB_ARN }} \
            --query 'Listeners[0].ListenerArn' \
            --output text)
          
          CANARY_WEIGHT=${{ github.event.inputs.canary-percentage }}
          STABLE_WEIGHT=$((100 - CANARY_WEIGHT))
          
          aws elbv2 modify-listener \
            --listener-arn $LISTENER_ARN \
            --default-actions Type=forward,ForwardConfig='{
              "TargetGroups": [
                {
                  "TargetGroupArn": "'$STABLE_TG_ARN'",
                  "Weight": '$STABLE_WEIGHT'
                },
                {
                  "TargetGroupArn": "'$CANARY_TG_ARN'",
                  "Weight": '$CANARY_WEIGHT'
                }
              ],
              "TargetGroupStickinessConfig": {
                "Enabled": false
              }
            }'

  monitor-canary:
    name: Monitor Canary Metrics
    needs: route-traffic
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Metrics Collection
        run: sleep 300 # Wait 5 minutes
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check Error Rate
        id: error-rate
        run: |
          ERROR_RATE=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/ApplicationELB \
            --metric-name HTTPCode_Target_5XX_Count \
            --dimensions Name=TargetGroup,Value=renthub-canary \
            --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
            --period 300 \
            --statistics Sum \
            --query 'Datapoints[0].Sum' \
            --output text)
          
          echo "error_rate=$ERROR_RATE" >> $GITHUB_OUTPUT
          
          if [ "$ERROR_RATE" -gt 10 ]; then
            echo "Error rate too high: $ERROR_RATE"
            exit 1
          fi
      
      - name: Check Latency
        id: latency
        run: |
          AVG_LATENCY=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/ApplicationELB \
            --metric-name TargetResponseTime \
            --dimensions Name=TargetGroup,Value=renthub-canary \
            --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
            --period 300 \
            --statistics Average \
            --query 'Datapoints[0].Average' \
            --output text)
          
          echo "latency=$AVG_LATENCY" >> $GITHUB_OUTPUT
          
          THRESHOLD=0.5
          if (( $(echo "$AVG_LATENCY > $THRESHOLD" | bc -l) )); then
            echo "Latency too high: $AVG_LATENCY seconds"
            exit 1
          fi
      
      - name: Check CPU Utilization
        run: |
          CPU_UTIL=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/ECS \
            --metric-name CPUUtilization \
            --dimensions Name=ServiceName,Value=renthub-canary Name=ClusterName,Value=${{ env.ECS_CLUSTER }} \
            --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
            --period 300 \
            --statistics Average \
            --query 'Datapoints[0].Average' \
            --output text)
          
          if (( $(echo "$CPU_UTIL > 80" | bc -l) )); then
            echo "CPU utilization too high: $CPU_UTIL%"
            exit 1
          fi
      
      - name: Run Synthetic Tests
        run: |
          # Run automated tests against canary
          for i in {1..10}; do
            curl -f https://renthub.com/health \
              -H "X-Canary-Test: true" || exit 1
          done

  promote-canary:
    name: Promote Canary to Stable
    needs: monitor-canary
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update Stable Service
        run: |
          CANARY_TASK_DEF=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services renthub-canary \
            --query 'services[0].taskDefinition' \
            --output text)
          
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service renthub-stable \
            --task-definition $CANARY_TASK_DEF \
            --force-new-deployment
      
      - name: Route All Traffic to Stable
        run: |
          STABLE_TG_ARN=$(aws elbv2 describe-target-groups \
            --names renthub-stable \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text)
          
          LISTENER_ARN=$(aws elbv2 describe-listeners \
            --load-balancer-arn ${{ secrets.ALB_ARN }} \
            --query 'Listeners[0].ListenerArn' \
            --output text)
          
          aws elbv2 modify-listener \
            --listener-arn $LISTENER_ARN \
            --default-actions Type=forward,TargetGroupArn=$STABLE_TG_ARN
      
      - name: Cleanup Canary
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service renthub-canary \
            --desired-count 0
      
      - name: Notify Success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'Canary deployment promoted to stable!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  rollback-canary:
    name: Rollback Canary
    needs: [route-traffic, monitor-canary]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Remove Canary Traffic
        run: |
          STABLE_TG_ARN=$(aws elbv2 describe-target-groups \
            --names renthub-stable \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text)
          
          LISTENER_ARN=$(aws elbv2 describe-listeners \
            --load-balancer-arn ${{ secrets.ALB_ARN }} \
            --query 'Listeners[0].ListenerArn' \
            --output text)
          
          aws elbv2 modify-listener \
            --listener-arn $LISTENER_ARN \
            --default-actions Type=forward,TargetGroupArn=$STABLE_TG_ARN
      
      - name: Stop Canary Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service renthub-canary \
            --desired-count 0
      
      - name: Notify Failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'Canary deployment failed and rolled back!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
