name: Code Quality Enforcement

on:
  pull_request:
    branches: [master, develop]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '20.x'
  PHP_VERSION: '8.3'

jobs:
  # ==================== LINT & TYPE CHECK ====================
  
  lint-enforcement:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: none
      
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: composer install --prefer-dist --no-progress
      
      - name: Run Frontend Linter
        working-directory: ./frontend
        run: |
          echo "## ðŸ” Frontend Linting Results" >> $GITHUB_STEP_SUMMARY
          npm run lint 2>&1 | tee lint-output.txt || true
          if grep -q "error" lint-output.txt; then
            echo "âŒ ESLint found errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… ESLint passed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Run TypeScript Check
        working-directory: ./frontend
        run: |
          echo "## ðŸ“˜ TypeScript Check Results" >> $GITHUB_STEP_SUMMARY
          npm run type-check 2>&1 | tee type-check-output.txt || true
          if grep -qE "error TS[0-9]+" type-check-output.txt; then
            echo "âŒ TypeScript errors found" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… TypeScript check passed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Run Backend Linter (Pint)
        working-directory: ./backend
        run: |
          echo "## ðŸ” Backend Linting Results" >> $GITHUB_STEP_SUMMARY
          if [ -f vendor/bin/pint ]; then
            vendor/bin/pint --test && echo "âœ… Pint check passed" >> $GITHUB_STEP_SUMMARY || {
              echo "âŒ Pint found issues" >> $GITHUB_STEP_SUMMARY
              exit 1
            }
          else
            echo "âš ï¸ Pint not installed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Run PHPStan
        working-directory: ./backend
        run: |
          echo "## ðŸ”¬ Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --memory-limit=2G && echo "âœ… PHPStan passed" >> $GITHUB_STEP_SUMMARY || {
              echo "âŒ PHPStan found issues" >> $GITHUB_STEP_SUMMARY
              exit 1
            }
          else
            echo "âš ï¸ PHPStan not installed" >> $GITHUB_STEP_SUMMARY
          fi

  # ==================== AUTO-FIX ATTEMPTS ====================
  
  auto-fix:
    name: ðŸ”§ Auto-Fix Code Issues
    runs-on: ubuntu-latest
    needs: lint-enforcement
    if: failure()
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl
      
      - name: Install Dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && composer install --prefer-dist --no-progress
      
      - name: Auto-fix Frontend Issues
        working-directory: ./frontend
        run: |
          # Try to auto-fix ESLint issues
          npm run lint -- --fix || true
      
      - name: Auto-fix Backend Issues
        working-directory: ./backend
        run: |
          # Try to auto-fix with Pint
          if [ -f vendor/bin/pint ]; then
            vendor/bin/pint || true
          fi
      
      - name: Commit Fixes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "chore: auto-fix linting issues"
          git push || echo "No fixes to push"

  # ==================== COMMIT MESSAGE VALIDATION ====================
  
  commit-message-check:
    name: ðŸ“ Commit Message Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate Commit Messages
        run: |
          echo "## ðŸ“ Commit Message Validation" >> $GITHUB_STEP_SUMMARY
          
          # Get all commits in this PR
          commits=$(git log --format="%H %s" origin/${{ github.base_ref }}..HEAD)
          
          valid=true
          while IFS= read -r line; do
            commit=$(echo "$line" | cut -d' ' -f1)
            message=$(echo "$line" | cut -d' ' -f2-)
            
            # Check conventional commit format
            if echo "$message" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: .+"; then
              echo "âœ… $message" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $message (not conventional commit format)" >> $GITHUB_STEP_SUMMARY
              valid=false
            fi
          done <<< "$commits"
          
          if [ "$valid" = false ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### â„¹ï¸ Conventional Commit Format" >> $GITHUB_STEP_SUMMARY
            echo "Format: \`type(scope): description\`" >> $GITHUB_STEP_SUMMARY
            echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci" >> $GITHUB_STEP_SUMMARY
          fi

  # ==================== DEPENDENCY UPDATES ====================
  
  check-outdated-dependencies:
    name: ðŸ“¦ Check for Outdated Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check Frontend Dependencies
        working-directory: ./frontend
        run: |
          echo "## ðŸ“¦ Frontend Dependencies" >> $GITHUB_STEP_SUMMARY
          npm outdated || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Check Backend Dependencies
        working-directory: ./backend
        run: |
          echo "## ðŸ“¦ Backend Dependencies" >> $GITHUB_STEP_SUMMARY
          composer outdated --direct || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          composer outdated --direct >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
