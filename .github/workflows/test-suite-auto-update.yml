name: Test Suite Auto-Update

on:
  push:
    branches: [master, develop]
    paths:
      - 'frontend/src/**/*.tsx'
      - 'frontend/src/**/*.ts'
      - 'frontend/app/**/*.tsx'
      - 'backend/app/**/*.php'
      - 'backend/routes/**/*.php'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'
  PHP_VERSION: '8.3'

jobs:
  # ==================== DETECT NEW ROUTES ====================
  
  detect-new-routes:
    name: ðŸ” Detect New Routes & Components
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl
      
      - name: Analyze Frontend Changes
        id: frontend-changes
        run: |
          echo "Analyzing frontend route changes..."
          
          # Find new page files
          new_pages=$(git diff --name-only HEAD~1 HEAD -- 'frontend/app/**/page.tsx' 'frontend/app/**/page.ts' | wc -l)
          echo "new_pages=$new_pages" >> $GITHUB_OUTPUT
          
          # List new pages
          if [ "$new_pages" -gt 0 ]; then
            echo "## ðŸ†• New Frontend Pages Detected" >> $GITHUB_STEP_SUMMARY
            git diff --name-only HEAD~1 HEAD -- 'frontend/app/**/page.tsx' 'frontend/app/**/page.ts' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Analyze Backend Changes
        id: backend-changes
        working-directory: ./backend
        run: |
          echo "Analyzing backend route changes..."
          
          # Find new controller files
          new_controllers=$(git diff --name-only HEAD~1 HEAD -- 'app/Http/Controllers/**/*.php' | wc -l)
          echo "new_controllers=$new_controllers" >> $GITHUB_OUTPUT
          
          # Find new routes
          route_changes=$(git diff --name-only HEAD~1 HEAD -- 'routes/*.php' | wc -l)
          echo "route_changes=$route_changes" >> $GITHUB_OUTPUT
          
          if [ "$new_controllers" -gt 0 ] || [ "$route_changes" -gt 0 ]; then
            echo "## ðŸ†• New Backend Routes Detected" >> $GITHUB_STEP_SUMMARY
            echo "Controllers changed: $new_controllers" >> $GITHUB_STEP_SUMMARY
            echo "Route files changed: $route_changes" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Generate Test Stubs
        if: steps.frontend-changes.outputs.new_pages > 0 || steps.backend-changes.outputs.new_controllers > 0
        run: |
          mkdir -p .github/test-recommendations
          
          cat > .github/test-recommendations/needed-tests.md << 'EOF'
          # Test Coverage Recommendations
          
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## New Components/Routes Requiring Tests
          
          ### Frontend
          EOF
          
          # List new frontend pages
          git diff --name-only HEAD~1 HEAD -- 'frontend/app/**/page.tsx' 'frontend/app/**/page.ts' | while read file; do
            echo "- [ ] E2E test for: $file" >> .github/test-recommendations/needed-tests.md
          done
          
          echo "" >> .github/test-recommendations/needed-tests.md
          echo "### Backend" >> .github/test-recommendations/needed-tests.md
          
          # List new backend controllers
          git diff --name-only HEAD~1 HEAD -- 'backend/app/Http/Controllers/**/*.php' | while read file; do
            echo "- [ ] API test for: $file" >> .github/test-recommendations/needed-tests.md
          done
          
          cat .github/test-recommendations/needed-tests.md
      
      - name: Create Issue for Missing Tests
        if: steps.frontend-changes.outputs.new_pages > 0 || steps.backend-changes.outputs.new_controllers > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const recommendations = fs.readFileSync('.github/test-recommendations/needed-tests.md', 'utf8');
            
            const title = `[QA] New Tests Needed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Test Coverage Gap Detected
            
            New routes/components have been added that require test coverage.
            
            ${recommendations}
            
            ### Action Items
            1. Review the list above
            2. Create appropriate tests (E2E and/or API)
            3. Ensure all new functionality is covered
            4. Update this issue as tests are added
            
            ### Guidelines
            - **E2E Tests**: Add to \`frontend/tests/e2e/\`
            - **API Tests**: Add to \`backend/tests/Feature/Api/\`
            - Follow existing test patterns and naming conventions
            
            [Commit that triggered this](${context.payload.repository.html_url}/commit/${context.sha})
            
            ---
            *This issue was automatically created by the Test Suite Auto-Update workflow*`;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'test-coverage'
            });
            
            const recentIssue = issues.data.find(issue => 
              issue.title.includes('New Tests Needed') &&
              new Date(issue.created_at) > new Date(Date.now() - 86400000) // Within last 24 hours
            );
            
            if (!recentIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['test-coverage', 'automated-qa', 'enhancement']
              });
            }

  # ==================== CHECK TEST COVERAGE ====================
  
  coverage-check:
    name: ðŸ“Š Test Coverage Analysis
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
          coverage: xdebug
      
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run Frontend Tests with Coverage
        working-directory: ./frontend
        run: |
          npm run test -- --coverage || true
      
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: composer install --prefer-dist --no-progress
      
      - name: Setup Backend Test Environment
        working-directory: ./backend
        run: |
          cp .env.example .env.testing
          php artisan key:generate --env=testing
          touch database/database.sqlite
          php artisan migrate --env=testing --force
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
      
      - name: Run Backend Tests with Coverage
        working-directory: ./backend
        run: |
          php artisan test --coverage --min=0 || true
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
      
      - name: Generate Coverage Report
        run: |
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage analysis completed. Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY

  # ==================== UPDATE E2E TEST SUITE ====================
  
  update-e2e-suite:
    name: ðŸ”„ Update E2E Test Suite
    runs-on: ubuntu-latest
    needs: detect-new-routes
    if: needs.detect-new-routes.outputs.new_pages > 0
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Scan for Uncovered Routes
        working-directory: ./frontend
        run: |
          echo "Scanning for routes without E2E tests..."
          
          # Find all page.tsx files
          find app -name "page.tsx" -o -name "page.ts" | while read page; do
            # Extract route from path
            route=$(echo "$page" | sed 's|app||' | sed 's|/page.tsx||' | sed 's|/page.ts||')
            
            # Check if E2E test exists for this route
            test_exists=$(find tests/e2e -name "*.spec.ts" -exec grep -l "$route" {} \; | wc -l)
            
            if [ "$test_exists" -eq 0 ]; then
              echo "Missing E2E test for route: $route"
            fi
          done
      
      - name: Generate Test Placeholders
        run: |
          echo "Test placeholder generation would happen here"
          # This would create skeleton test files for new routes
