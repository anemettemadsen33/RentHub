name: Setup Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-prometheus:
    name: Deploy Prometheus
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        if [ "${{ github.event.inputs.environment }}" == "production" ]; then
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > $HOME/.kube/config
        else
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
        fi
    
    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.12.0'
    
    - name: Add Prometheus Helm repo
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
    
    - name: Install Prometheus Stack
      run: |
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --create-namespace \
          --set prometheus.prometheusSpec.retention=30d \
          --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=50Gi \
          --set grafana.enabled=true \
          --set grafana.adminPassword=${{ secrets.GRAFANA_PASSWORD }} \
          --wait
    
    - name: Apply ServiceMonitors
      run: |
        kubectl apply -f k8s/monitoring/service-monitors.yaml

  deploy-loki:
    name: Deploy Loki
    runs-on: ubuntu-latest
    needs: deploy-prometheus
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup kubectl and Helm
      uses: azure/setup-helm@v3
    
    - name: Add Grafana Helm repo
      run: |
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
    
    - name: Install Loki
      run: |
        helm upgrade --install loki grafana/loki-stack \
          --namespace monitoring \
          --set loki.persistence.enabled=true \
          --set loki.persistence.size=50Gi \
          --set promtail.enabled=true \
          --wait

  configure-alerts:
    name: Configure Alerts
    runs-on: ubuntu-latest
    needs: deploy-prometheus
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Apply AlertManager config
      run: |
        kubectl apply -f k8s/monitoring/alertmanager-config.yaml
    
    - name: Apply PrometheusRules
      run: |
        kubectl apply -f k8s/monitoring/prometheus-rules.yaml
