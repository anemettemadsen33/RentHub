# Prometheus Configuration for RentHub
prometheus:
  prometheusSpec:
    retention: 15d
    retentionSize: "50GB"
    
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 100Gi

    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 8Gi

    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    
    additionalScrapeConfigs:
      # Laravel Application Metrics
      - job_name: 'renthub-backend'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - renthub
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: backend
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__

      # PostgreSQL Metrics
      - job_name: 'postgres'
        static_configs:
          - targets: ['postgres-exporter:9187']

      # Redis Metrics  
      - job_name: 'redis'
        static_configs:
          - targets: ['redis-exporter:9121']

      # Custom Business Metrics
      - job_name: 'renthub-business-metrics'
        scrape_interval: 60s
        static_configs:
          - targets: ['backend-service:9000']
        metrics_path: '/api/v1/metrics/business'

    # Alert Manager Configuration
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - alertmanager:9093

# Grafana Configuration
grafana:
  enabled: true
  
  adminPassword: "changeme"  # Change in production
  
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: gp3

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - grafana.renthub.com
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.renthub.com

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-operated:9090
          isDefault: true
          access: proxy
        
        - name: Loki
          type: loki
          url: http://loki:3100
          access: proxy
        
        - name: PostgreSQL
          type: postgres
          url: postgres:5432
          database: renthub
          user: grafana_reader
          secureJsonData:
            password: 'changeme'

  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'renthub'
          orgId: 1
          folder: 'RentHub'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/renthub

  dashboardsConfigMaps:
    renthub: "renthub-dashboards"

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  plugins:
    - grafana-piechart-panel
    - grafana-worldmap-panel
    - grafana-clock-panel

# AlertManager Configuration
alertmanager:
  config:
    global:
      resolve_timeout: 5m
      slack_api_url: 'YOUR_SLACK_WEBHOOK_URL'

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'default'
      routes:
        - match:
            severity: critical
          receiver: 'critical'
          continue: true
        
        - match:
            severity: warning
          receiver: 'warning'

    receivers:
      - name: 'default'
        email_configs:
          - to: 'devops@renthub.com'
            send_resolved: true
        
      - name: 'critical'
        email_configs:
          - to: 'devops@renthub.com,cto@renthub.com'
            send_resolved: true
        slack_configs:
          - channel: '#alerts-critical'
            title: 'üö® Critical Alert'
            text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
            send_resolved: true
        pagerduty_configs:
          - service_key: 'YOUR_PAGERDUTY_KEY'
      
      - name: 'warning'
        slack_configs:
          - channel: '#alerts-warning'
            title: '‚ö†Ô∏è Warning Alert'
            text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
            send_resolved: true

  persistence:
    enabled: true
    size: 10Gi
    storageClassName: gp3

# PostgreSQL Exporter
postgresql-exporter:
  enabled: true
  config:
    datasource:
      host: postgres
      user: exporter
      password: changeme
      database: renthub
      sslmode: require

# Redis Exporter
redis-exporter:
  enabled: true
  redisAddress: redis://redis:6379
  
# Node Exporter
nodeExporter:
  enabled: true

# Kube State Metrics
kubeStateMetrics:
  enabled: true

# Service Monitors
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
