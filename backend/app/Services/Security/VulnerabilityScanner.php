<?php

namespace App\Services\Security;

use Illuminate\Support\Facades\DB;

class VulnerabilityScanner
{
    private array $vulnerabilities = [];

    /**
     * Run comprehensive security scan
     */
    public function runScan(): array
    {
        $this->vulnerabilities = [];

        $this->checkSQLInjection();
        $this->checkXSSVulnerabilities();
        $this->checkCSRFProtection();
        $this->checkSecurityHeaders();
        $this->checkFilePermissions();
        $this->checkDependencyVulnerabilities();
        $this->checkPasswordPolicies();
        $this->checkEncryption();
        $this->checkRateLimiting();
        $this->checkSessionSecurity();

        return [
            'scan_date' => now()->toIso8601String(),
            'total_vulnerabilities' => count($this->vulnerabilities),
            'critical' => count(array_filter($this->vulnerabilities, fn ($v) => $v['severity'] === 'critical')),
            'high' => count(array_filter($this->vulnerabilities, fn ($v) => $v['severity'] === 'high')),
            'medium' => count(array_filter($this->vulnerabilities, fn ($v) => $v['severity'] === 'medium')),
            'low' => count(array_filter($this->vulnerabilities, fn ($v) => $v['severity'] === 'low')),
            'vulnerabilities' => $this->vulnerabilities,
        ];
    }

    /**
     * Check SQL injection vulnerabilities
     */
    private function checkSQLInjection(): void
    {
        if (! config('security.app_security.sql_injection.use_prepared_statements', true)) {
            $this->addVulnerability(
                'sql_injection',
                'critical',
                'Prepared statements not enforced',
                'Enable prepared statements in security config'
            );
        }

        // Check for potential raw queries
        $routes = app('router')->getRoutes();
        foreach ($routes as $route) {
            // Scan route controller for DB::raw usage
            // This is a simplified check
        }
    }

    /**
     * Check XSS vulnerabilities
     */
    private function checkXSSVulnerabilities(): void
    {
        if (! config('security.app_security.xss_protection.enabled', true)) {
            $this->addVulnerability(
                'xss',
                'high',
                'XSS protection disabled',
                'Enable XSS protection in security config'
            );
        }

        if (! config('security.app_security.xss_protection.content_security_policy', true)) {
            $this->addVulnerability(
                'xss',
                'medium',
                'Content Security Policy not enabled',
                'Enable CSP in security config'
            );
        }
    }

    /**
     * Check CSRF protection
     */
    private function checkCSRFProtection(): void
    {
        if (! config('security.app_security.csrf_protection.enabled', true)) {
            $this->addVulnerability(
                'csrf',
                'critical',
                'CSRF protection disabled',
                'Enable CSRF protection immediately'
            );
        }
    }

    /**
     * Check security headers
     */
    private function checkSecurityHeaders(): void
    {
        $requiredHeaders = [
            'X-Content-Type-Options' => 'nosniff',
            'X-Frame-Options' => 'DENY',
            'Strict-Transport-Security' => 'max-age',
        ];

        $headers = config('security.headers', []);

        foreach ($requiredHeaders as $header => $expectedValue) {
            if (! isset($headers[$header])) {
                $this->addVulnerability(
                    'security_headers',
                    'medium',
                    "Missing security header: {$header}",
                    "Add {$header} header to security config"
                );
            }
        }
    }

    /**
     * Check file permissions
     */
    private function checkFilePermissions(): void
    {
        $sensitiveFiles = [
            '.env' => 0600,
            'storage/' => 0755,
            'bootstrap/cache/' => 0755,
        ];

        foreach ($sensitiveFiles as $file => $expectedPerms) {
            $path = base_path($file);
            if (file_exists($path)) {
                $perms = fileperms($path) & 0777;
                if ($perms > $expectedPerms) {
                    $this->addVulnerability(
                        'file_permissions',
                        'high',
                        "Insecure permissions on {$file}: ".decoct($perms),
                        'Set permissions to '.decoct($expectedPerms)
                    );
                }
            }
        }
    }

    /**
     * Check dependency vulnerabilities
     */
    private function checkDependencyVulnerabilities(): void
    {
        $composerLock = base_path('composer.lock');

        if (! file_exists($composerLock)) {
            $this->addVulnerability(
                'dependencies',
                'medium',
                'composer.lock file not found',
                'Run composer install to generate lock file'
            );

            return;
        }

        // Check against known vulnerability databases
        // This would integrate with services like Snyk or GitHub Advisory Database
    }

    /**
     * Check password policies
     */
    private function checkPasswordPolicies(): void
    {
        $minLength = config('security.password.min_length', 8);

        if ($minLength < 8) {
            $this->addVulnerability(
                'password_policy',
                'high',
                'Password minimum length too short',
                'Increase minimum password length to at least 8 characters'
            );
        }

        if (! config('security.password.require_symbols', false)) {
            $this->addVulnerability(
                'password_policy',
                'medium',
                'Passwords do not require symbols',
                'Enable symbol requirement in password policy'
            );
        }
    }

    /**
     * Check encryption settings
     */
    private function checkEncryption(): void
    {
        if (! config('security.encryption.at_rest.enabled', true)) {
            $this->addVulnerability(
                'encryption',
                'critical',
                'Data encryption at rest disabled',
                'Enable encryption at rest in security config'
            );
        }

        if (! config('security.encryption.in_transit.force_tls', true)) {
            $this->addVulnerability(
                'encryption',
                'critical',
                'TLS not enforced',
                'Enable forced TLS in security config'
            );
        }

        $minTLS = config('security.encryption.in_transit.min_tls_version', '1.2');
        if (version_compare($minTLS, '1.3', '<')) {
            $this->addVulnerability(
                'encryption',
                'medium',
                'TLS version below 1.3',
                'Upgrade minimum TLS version to 1.3'
            );
        }
    }

    /**
     * Check rate limiting
     */
    private function checkRateLimiting(): void
    {
        if (! config('security.rate_limiting.enabled', true)) {
            $this->addVulnerability(
                'rate_limiting',
                'high',
                'Rate limiting disabled',
                'Enable rate limiting to prevent abuse'
            );
        }
    }

    /**
     * Check session security
     */
    private function checkSessionSecurity(): void
    {
        if (! config('security.session.secure', true)) {
            $this->addVulnerability(
                'session',
                'high',
                'Secure cookie flag not set',
                'Enable secure cookies in session config'
            );
        }

        if (! config('security.session.http_only', true)) {
            $this->addVulnerability(
                'session',
                'high',
                'HttpOnly cookie flag not set',
                'Enable HttpOnly flag in session config'
            );
        }
    }

    /**
     * Add vulnerability to list
     */
    private function addVulnerability(string $type, string $severity, string $description, string $recommendation): void
    {
        $this->vulnerabilities[] = [
            'type' => $type,
            'severity' => $severity,
            'description' => $description,
            'recommendation' => $recommendation,
            'detected_at' => now()->toIso8601String(),
        ];
    }

    /**
     * Generate security report
     */
    public function generateReport(): string
    {
        $scan = $this->runScan();

        $report = "# Security Vulnerability Report\n\n";
        $report .= "Generated: {$scan['scan_date']}\n\n";
        $report .= "## Summary\n\n";
        $report .= "- Total Vulnerabilities: {$scan['total_vulnerabilities']}\n";
        $report .= "- Critical: {$scan['critical']}\n";
        $report .= "- High: {$scan['high']}\n";
        $report .= "- Medium: {$scan['medium']}\n";
        $report .= "- Low: {$scan['low']}\n\n";

        if (! empty($scan['vulnerabilities'])) {
            $report .= "## Vulnerabilities\n\n";

            foreach ($scan['vulnerabilities'] as $vuln) {
                $report .= "### [{$vuln['severity']}] {$vuln['type']}\n\n";
                $report .= "**Description:** {$vuln['description']}\n\n";
                $report .= "**Recommendation:** {$vuln['recommendation']}\n\n";
                $report .= "---\n\n";
            }
        }

        return $report;
    }
}
