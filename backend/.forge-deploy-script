#!/bin/bash

set -e

echo "ðŸš€ Starting deployment..."

# Navigate to project directory (Forge automatically sets this)
cd $FORGE_SITE_PATH

# Enter maintenance mode
php artisan down || true

# Pull latest changes from Git
git pull origin $FORGE_SITE_BRANCH

# Install/Update dependencies
composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

# Clear all caches before migration
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Run migrations
php artisan migrate --force

# Optimize application
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Storage link (if not exists)
php artisan storage:link || true

# Restart queue workers
php artisan queue:restart

# Exit maintenance mode
php artisan up

echo "âœ… Deployment completed successfully!"
